apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: smartfaq-api
spec:
  serviceName: smartfaq-api
  replicas: 2
  selector:
    matchLabels:
      app: smartfaq-api
  template:
    metadata:
      labels:
        app: smartfaq-api
      annotations:
        checksum/config: "{{ .Values.configChecksum }}"
    spec:
      securityContext:
        fsGroup: 1000
        runAsNonRoot: true
        runAsGroup: 1000
        runAsUser: 1000
        fsGroupChangePolicy: "OnRootMismatch"
      initContainers:
        - name: db-migration
          image: asia-southeast1-docker.pkg.dev/enspara/smartfaq/smartfaq-api:latest
          command:
            - python
            - -c
            - |
              import psycopg
              import time
              import os
              import subprocess

              print("Checking database connection...")
              conn_str = os.environ['DATABASE_URL']
              max_retries = 30
              retry = 0

              while retry < max_retries:
                  try:
                      conn = psycopg.connect(conn_str)
                      conn.close()
                      print('Database connected successfully')
                      break
                  except Exception as e:
                      retry += 1
                      print(f'Waiting for database... ({retry}/{max_retries}): {e}')
                      time.sleep(5)
              else:
                  print(f'Failed to connect to database after {max_retries} retries')
                  exit(1)

              print("Running migrations...")
              result = subprocess.run(['alembic', 'upgrade', 'head'], capture_output=True, text=True)
              print(result.stdout)
              if result.stderr:
                  print(result.stderr)
              if result.returncode != 0:
                  print(f"Migration failed with code {result.returncode}")
                  exit(result.returncode)
              print("Migration completed successfully")
          envFrom:
            - secretRef:
                name: smartfaq-api-env
          volumeMounts:
            - name: tmp-volume
              mountPath: /tmp
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsGroup: 1000
            runAsUser: 1000
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          resources:
            requests:
              memory: "512Mi"
              cpu: "500m"
            limits:
              memory: "1Gi"
              cpu: "1"
      containers:
        - name: smartfaq-api
          image: asia-southeast1-docker.pkg.dev/enspara/smartfaq/smartfaq-api:latest
          ports:
            - name: http
              containerPort: 8000
              protocol: TCP
          env:
            - name: UVICORN_WORKERS
              value: "2"
          envFrom:
            - secretRef:
                name: smartfaq-api-env
          volumeMounts:
            - name: storage-volume
              mountPath: /app/uploads
            - name: tmp-volume
              mountPath: /tmp
            - name: model-cache-volume
              mountPath: /app/.cache
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsGroup: 1000
            runAsUser: 1000
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          resources:
            requests:
              memory: 3Gi
              cpu: "2"
            limits:
              memory: 6Gi
              cpu: "4"
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
      volumes:
        - name: tmp-volume
          emptyDir: {}
  volumeClaimTemplates:
    - metadata:
        name: storage-volume
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: standard-rwo
        resources:
          requests:
            storage: 20Gi
    - metadata:
        name: model-cache-volume
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: standard-rwo
        resources:
          requests:
            storage: 3Gi
